
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orchestrator Demo UI</title>
  <link rel="stylesheet" href="/v1/orchestrator/styles.css" />
</head>
<body>
  <header>
    <h1>Orchestrator Demo UI</h1>
    <nav>
      <a href="#inputs">Inputs</a>
      <a href="#outputs">Outputs</a>
      <a href="#workflows">Workflows</a>
      <a href="#enrichment">Enrichment</a>
      <a href="/v1/orchestrator/openapi.yaml" target="_blank">OpenAPI</a>
    </nav>
  </header>

  <main>
    <section id="inputs">
      <h2>Inputs</h2>
      <form id="inputForm">
        <label>source <input name="source" value="demo-ui" required></label>
        <label>topic <input name="topic" value="demo/topic" required></label>
        <label>type <input name="type" value="demo"></label>
        <label>payload(JSON) <textarea name="payload">{"message":"hello"}</textarea></label>
        <button type="submit">Send</button>
      </form>
      <div class="table-wrap">
        <table id="inputsTable">
          <thead><tr><th>time</th><th>source</th><th>topic</th><th>type</th><th>payload</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="outputs">
      <h2>Outputs</h2>
      <div class="table-wrap">
        <table id="outputsTable">
          <thead><tr><th>time</th><th>source</th><th>topic</th><th>type</th><th>payload</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="workflows">
      <h2>Workflows</h2>
      <form id="wfForm">
        <label>name <input name="name" value="wf-demo" required></label>
        <label>enabled <input type="checkbox" name="enabled" checked></label>
        <label>sourceTopics (comma) <input name="sourceTopics" value="demo/topic"></label>
        <label>outputTopic <input name="outputTopic" value="demo/output"></label>
        <label>loopback <input type="checkbox" name="loopbackToInput"></label>
        <label>steps(JSON)
          <textarea name="steps">[
  {"type":"debounce","ms":200},
  {"type":"enrich","sourceId":"prefectures","params":{"code":"payload.prefCode"},"targetField":"payload.enriched.pref"},
  {"type":"tapLog","label":"debug"},
  {"type":"branch","branches":[
     {"when":{"field":"payload.message","equals":"hello"},
      "set":{"reply":"world"},
      "outputTopic":"demo/branch"}
  ]}
]</textarea></label>
        <button type="submit">Create Workflow</button>
      </form>

      <div class="table-wrap">
        <table id="wfTable">
          <thead><tr><th>id</th><th>name</th><th>enabled</th><th>sourceTopics</th><th>outputTopic</th><th>actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <details>
        <summary>ロジックの説明</summary>
        <ul>
          <li><b>filterEquals</b>: 指定フィールドが値と一致するイベントのみ通過</li>
          <li><b>mapFields</b>: `{ 目標パス: 取得元パス }` で payload を再構成</li>
          <li><b>debounce</b>: 直近の値のみを遅延出力 (ms)</li>
          <li><b>throttle</b>: 高頻度入力を一定間隔で間引き (ms)</li>
          <li><b>delay</b>: 出力を遅延 (ms)</li>
          <li><b>enrich</b>: 外部データ取得 + キャッシュを行い、結果を payload に補完</li>
          <li><b>setTopic</b>: イベントの topic を差し替え</li>
          <li><b>mergeWithTopics</b>: 他トピックのイベントを合流</li>
          <li><b>raceTopics</b>: 複数トピックのうち最初に来たストリームに追従</li>
          <li><b>branch</b>: 条件にマッチした場合、<i>サイド出力</i>として即時に output を発行 (元イベントは流れ続けます)</li>
          <li><b>tapLog</b>: コンソールにデバッグ出力</li>
        </ul>
      </details>
    </section>

    <section id="enrichment">
      <h2>Enrichment (補完) の使い方</h2>
      <p>
        <b>enrich</b> ステップは、イベント内の値をパラメータにして外部 GET を行い、
        結果を payload に書き込みます。キャッシュがあるため毎回のリクエストは避けられます。
      </p>

      <div class="toolbar">
        <button id="enrichReload">補完ソースを再読み込み</button>
        <button id="enrichClearCache">キャッシュ全消去</button>
        <span class="muted">cache size: <b id="enrichCacheSize">-</b></span>
      </div>

      <div class="table-wrap">
        <table id="enrichTable">
          <thead>
            <tr>
              <th>id</th>
              <th>ttlMs</th>
              <th>refreshIntervalMs</th>
              <th>refreshable</th>
              <th>actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3>1) 入力イベント例</h3>
      <pre><code>{
  "source": "demo-ui",
  "topic": "demo/topic",
  "type": "demo",
  "payload": {
    "message": "hello",
    "prefCode": 13,
    "userId": 1
  }
}</code></pre>

      <h3>2) ワークフローの例 (steps のみ)</h3>
      <pre><code>[
  {
    "type": "enrich",
    "sourceId": "prefectures",
    "params": { "code": "payload.prefCode" },
    "targetField": "payload.enriched.pref"
  },
  {
    "type": "enrich",
    "sourceId": "jsonplaceholder-user",
    "params": { "id": "payload.userId" },
    "targetField": "payload.enriched.user",
    "cacheTtlMs": 300000
  }
]</code></pre>

      <h3>3) 補完結果 (出力 payload の例)</h3>
      <pre><code>{
  "message": "hello",
  "prefCode": 13,
  "userId": 1,
  "enriched": {
    "pref": { "code": 13, "name": "東京都" },
    "user": { "id": 1, "name": "Leanne Graham", "username": "Bret", ... }
  }
}</code></pre>

      <details>
        <summary>利用可能な補完ソース (デフォルト)</summary>
        <ul>
          <li><b>prefectures</b>: 静的リスト (北海道 / 東京都 / 大阪府 をサンプル内蔵)</li>
          <li><b>jsonplaceholder-user</b>: https://jsonplaceholder.typicode.com/users/{id} (GET)</li>
        </ul>
        <p>追加の補完ソースは <code>src/enrichment.ts</code> にハードコードで定義可能です。</p>
      </details>
    </section>
  </main>

  <footer>
    <small>Orchestrator Demo — Node.js + TypeScript + RxJS</small>
  </footer>

  <script src="/v1/orchestrator/app.js"></script>
</body>
</html>
