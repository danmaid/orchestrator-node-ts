
openapi: 3.1.0
info:
  title: Orchestrator API
  version: 0.1.0
  description: |
    SSE 対応のオーケストレータ API。`/v1/orchestrator` を起点に、inputs/outputs/workflows/logics/enrichments を管理します。
servers:
  - url: /v1/orchestrator
paths:
  /health:
    get:
      summary: ヘルスチェック
      responses:
        '200':
          description: OK
  /inputs:
    get:
      summary: 入力定義一覧取得
      responses:
        '200': { description: OK }
    post:
      summary: 入力定義作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InputDefinition'
      responses:
        '201': { description: Created }
  /inputs/{id}:
    get:
      summary: 入力定義取得
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    put:
      summary: 入力定義置換
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/InputDefinition' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    patch:
      summary: 入力定義更新
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/InputDefinition' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    delete:
      summary: 入力定義削除
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: No Content }
        '404': { description: Not Found }
  /inputs/stream:
    get:
      summary: 入力イベントの SSE ストリーム
      responses:
        '200': { description: text/event-stream }
  /inputs/{id}/enable:
    post:
      summary: 入力定義の有効化
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /inputs/{id}/disable:
    post:
      summary: 入力定義の無効化
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /input-events:
    get:
      summary: 入力イベントバッファ参照
      responses:
        '200': { description: OK }
    post:
      summary: 入力イベント投入（手動）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source, topic]
              properties:
                source: { type: string }
                topic: { type: string }
                type: { type: string }
                payload: { }
                meta: { type: object }
      responses:
        '202': { description: Accepted }
  /input-events/stream:
    get:
      summary: 入力イベント SSE ストリーム
      responses:
        '200': { description: text/event-stream }
  /outputs:
    get:
      summary: 出力定義一覧取得
      responses:
        '200': { description: OK }
    post:
      summary: 出力定義作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OutputDefinition'
      responses:
        '201': { description: Created }
  /outputs/{id}:
    get:
      summary: 出力定義取得
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    put:
      summary: 出力定義置換
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/OutputDefinition' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    patch:
      summary: 出力定義更新
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/OutputDefinition' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    delete:
      summary: 出力定義削除
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: No Content }
        '404': { description: Not Found }
  /outputs/stream:
    get:
      summary: 出力イベントの SSE ストリーム
      responses:
        '200': { description: text/event-stream }
  /outputs/{id}/enable:
    post:
      summary: 出力定義の有効化
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /outputs/{id}/disable:
    post:
      summary: 出力定義の無効化
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /events/stream:
    get:
      summary: 入出力/ワークフローの統合 SSE ストリーム
      responses:
        '200': { description: text/event-stream }
  /broadcast/stream:
    get:
      summary: ブロードキャスト SSE ストリーム
      responses:
        '200': { description: text/event-stream }
  /workflows:
    get:
      summary: ワークフロー一覧取得
      responses:
        '200': { description: OK }
    post:
      summary: ワークフロー作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Workflow'
      responses:
        '201': { description: Created }
  /workflows/stream:
    get:
      summary: ワークフローステータスの SSE ストリーム
      responses:
        '200': { description: text/event-stream }
  /workflows/{id}:
    get:
      summary: ワークフロー取得
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    put:
      summary: ワークフロー置換
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Workflow' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    delete:
      summary: ワークフロー削除
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: No Content }
        '404': { description: Not Found }
  /workflows/{id}/enable:
    post:
      summary: ワークフロー有効化
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /workflows/{id}/disable:
    post:
      summary: ワークフロー無効化
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /enrichments:
    get:
      summary: 補完ソース一覧取得
      responses:
        '200': { description: OK }
  /enrichments/cache:
    post:
      summary: 補完キャッシュ全消去
      responses:
        '200': { description: OK }
  /enrichments/{id}/refresh:
    post:
      summary: 補完ソースのリフレッシュ
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '400': { description: Refresh Not Supported }
        '404': { description: Not Found }
  /enrichments/{id}/cache/clear:
    post:
      summary: 補完ソース単位のキャッシュ消去
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
  /logics:
    get:
      summary: Logic 定義一覧取得
      responses:
        '200': { description: OK }
    post:
      summary: Logic 定義作成（Webhook）
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogicDefinition'
      responses:
        '201': { description: Created }
  /logics/{id}:
    get:
      summary: Logic 定義取得
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    put:
      summary: Logic 定義置換（Webhook）
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LogicDefinition' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    patch:
      summary: Logic 定義更新（Webhook）
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LogicDefinition' }
      responses:
        '200': { description: OK }
        '404': { description: Not Found }
    delete:
      summary: Logic 定義削除（Webhook）
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: No Content }
        '404': { description: Not Found }
components:
  schemas:
    InputDefinition:
      type: object
      required: [name, type, enabled, config]
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string, enum: [webhook, udp, tail, timer, loopback] }
        enabled: { type: boolean }
        description: { type: string }
        workflowId: { type: string }
        topic: { type: string }
        source: { type: string }
        eventType: { type: string }
        mode: { type: string, enum: [raw, aggregate] }
        config:
          oneOf:
            - $ref: '#/components/schemas/WebhookInputConfig'
            - $ref: '#/components/schemas/UdpInputConfig'
            - $ref: '#/components/schemas/TailInputConfig'
            - $ref: '#/components/schemas/TimerInputConfig'
            - { type: object }
    WebhookInputConfig:
      type: object
      properties:
        path: { type: string }
        method: { type: string }
        authToken: { type: string }
    UdpInputConfig:
      type: object
      required: [port]
      properties:
        port: { type: integer }
        host: { type: string }
        codec: { type: string, enum: [utf8, json, raw] }
    TailInputConfig:
      type: object
      required: [path]
      properties:
        path: { type: string }
        from: { type: string, enum: [start, end] }
        codec: { type: string, enum: [utf8, json] }
        pollIntervalMs: { type: integer }
    TimerInputConfig:
      type: object
      properties:
        intervalMs: { type: integer }
        emitOnStart: { type: boolean }
        payload: { type: object }
    Workflow:
      type: object
      required: [name, enabled, steps]
      properties:
        id: { type: string }
        name: { type: string }
        enabled: { type: boolean }
        description: { type: string }
        sourceTopics: { type: array, items: { type: string } }
        steps:
          type: array
          items:
            oneOf:
              - $ref: '#/components/schemas/StepFilterEquals'
              - $ref: '#/components/schemas/StepMapFields'
              - $ref: '#/components/schemas/StepDebounce'
              - $ref: '#/components/schemas/StepThrottle'
              - $ref: '#/components/schemas/StepDelay'
              - $ref: '#/components/schemas/StepAggregateCount'
              - $ref: '#/components/schemas/StepOutput'
              - $ref: '#/components/schemas/StepBranch'
              - $ref: '#/components/schemas/StepEnrich'
              - $ref: '#/components/schemas/StepLogic'
              - $ref: '#/components/schemas/StepSetTopic'
              - $ref: '#/components/schemas/StepMergeWithTopics'
              - $ref: '#/components/schemas/StepRaceTopics'
              - $ref: '#/components/schemas/StepTapLog'
        outputTopic: { type: string }
        loopbackToInput: { type: boolean }
        outputs:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowOutputDefinition'
    LogicDefinition:
      type: object
      required: [name, type, enabled]
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string, enum: [builtin, embedded, webhook] }
        enabled: { type: boolean }
        description: { type: string }
        config:
          oneOf:
            - $ref: '#/components/schemas/WebhookLogicConfig'
            - { type: object }
    WebhookLogicConfig:
      type: object
      required: [url]
      properties:
        url: { type: string }
        method: { type: string, enum: [GET, POST, PUT, PATCH, DELETE] }
        headers: { type: object, additionalProperties: { type: string } }
        timeoutMs: { type: integer }
        ttlMs: { type: integer }
    StepFilterEquals:
      type: object
      properties:
        type: { const: filterEquals }
        field: { type: string }
        value: { }
    StepMapFields:
      type: object
      properties:
        type: { const: mapFields }
        mapping: { type: object, additionalProperties: { type: string } }
    StepDebounce:
      type: object
      properties:
        type: { const: debounce }
        ms: { type: integer }
    StepThrottle:
      type: object
      properties:
        type: { const: throttle }
        ms: { type: integer }
    StepDelay:
      type: object
      properties:
        type: { const: delay }
        ms: { type: integer }
    StepAggregateCount:
      type: object
      properties:
        type: { const: aggregateCount }
        windowMs: { type: integer }
        keyField: { type: string }
        outputTopic: { type: string }
        eventType: { type: string }
    StepOutput:
      type: object
      properties:
        type: { const: output }
        target: { type: string, description: output/<target> へ送信。 }
        topic: { type: string, description: 明示的な output topic。target より優先。 }
    StepBranch:
      type: object
      properties:
        type: { const: branch }
        branches:
          type: array
          items:
            type: object
            properties:
              when:
                type: object
                properties:
                  field: { type: string }
                  equals: { }
              set: { type: object }
              outputTopic: { type: string }
        else:
          type: object
          properties:
            set: { type: object }
            outputTopic: { type: string }
    StepEnrich:
      type: object
      properties:
        type: { const: enrich }
        sourceId: { type: string }
        params: { type: object, additionalProperties: { type: string } }
        targetField: { type: string }
        errorField: { type: string }
        onError: { type: string, enum: [skip, pass, setError] }
        cacheTtlMs: { type: integer }
        concurrency: { type: integer }
    StepLogic:
      type: object
      properties:
        type: { const: logic }
        logicId: { type: string }
        params: { type: object, additionalProperties: { type: string } }
        targetField: { type: string }
        errorField: { type: string }
        onError: { type: string, enum: [skip, pass, setError] }
        cacheTtlMs: { type: integer }
        concurrency: { type: integer }
    StepSetTopic:
      type: object
      properties:
        type: { const: setTopic }
        topic: { type: string }
    StepMergeWithTopics:
      type: object
      properties:
        type: { const: mergeWithTopics }
        topics: { type: array, items: { type: string } }
    StepRaceTopics:
      type: object
      properties:
        type: { const: raceTopics }
        topics: { type: array, items: { type: string } }
        windowMs: { type: integer }
    StepTapLog:
      type: object
      properties:
        type: { const: tapLog }
        label: { type: string }
    WorkflowOutputDefinition:
      type: object
      properties:
        type: { type: string, enum: [topic, broadcast] }
        topic: { type: string }
        channel: { type: string, enum: [inputs, outputs, workflows, events, broadcast] }
        eventName: { type: string }
    OutputDefinition:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string, enum: [sse, ws] }
        enabled: { type: boolean }
        description: { type: string }
        builtin: { type: boolean }
        config:
          type: object
          properties:
            path: { type: string }
            channel: { type: string, enum: [inputs, outputs, workflows, events, broadcast] }
